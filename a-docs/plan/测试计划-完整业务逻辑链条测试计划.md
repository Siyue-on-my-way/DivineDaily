# DivineDaily å®Œæ•´ä¸šåŠ¡é€»è¾‘é“¾æ¡æµ‹è¯•è®¡åˆ’

**åˆ›å»ºæ—¶é—´**: 2026-02-16  
**ç›®æ ‡**: ç¡®ä¿æµ‹è¯•è¦†ç›–å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘é“¾æ¡ï¼ŒéªŒè¯æ¯ä¸ªç¯èŠ‚çš„æ­£ç¡®æ€§

---

## ğŸ¯ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘é“¾æ¡

### é“¾æ¡ 1: å‘¨æ˜“å åœå®Œæ•´æµç¨‹
```
ç”¨æˆ·æé—® 
  â†’ æ„å›¾è¯†åˆ« (IntentRecognitionService)
  â†’ é—®é¢˜åˆ†æ (QuestionAnalyzer) 
  â†’ å…­çˆ»èµ·å¦ (IChingService)
  â†’ å¦è±¡è§£æ (HexagramData)
  â†’ Promptæ„å»º (PromptBuilder)
  â†’ LLMè°ƒç”¨ (LLMService)
  â†’ ç»“æœå¢å¼º (EnhancedDivinationService)
  â†’ æ•°æ®åº“ä¿å­˜ (DivinationSession)
  â†’ è¿”å›ç»“æœ
```

### é“¾æ¡ 2: å¡”ç½—å åœå®Œæ•´æµç¨‹
```
ç”¨æˆ·æé—®
  â†’ æ„å›¾è¯†åˆ«
  â†’ å¡”ç½—æŠ½ç‰Œ (TarotService)
  â†’ ç‰Œé¢è§£æ (TarotData)
  â†’ Promptæ„å»º
  â†’ LLMè°ƒç”¨
  â†’ ç»“æœå¢å¼º
  â†’ æ•°æ®åº“ä¿å­˜
  â†’ è¿”å›ç»“æœ
```

### é“¾æ¡ 3: æ¯æ—¥è¿åŠ¿å®Œæ•´æµç¨‹
```
ç”¨æˆ·è¯·æ±‚
  â†’ ç”¨æˆ·æ¡£æ¡ˆè·å– (UserProfileService)
  â†’ æ—¶é—´è½¬æ¢ (TimeConvertService)
  â†’ èŠ‚æ°”èŠ‚æ—¥è®¡ç®—
  â†’ Promptæ„å»º
  â†’ LLMè°ƒç”¨
  â†’ è¿åŠ¿ç”Ÿæˆ (DailyFortuneService)
  â†’ æ•°æ®åº“ä¿å­˜
  â†’ è¿”å›ç»“æœ
```

### é“¾æ¡ 4: ç®¡ç†ç«¯é…ç½®æµç¨‹
```
ç®¡ç†å‘˜ç™»å½•
  â†’ LLMé…ç½®åˆ›å»º
  â†’ LLMçœŸå®è°ƒç”¨æµ‹è¯•
  â†’ Assistanté…ç½®åˆ›å»º
  â†’ Promptæ¨¡æ¿æ¸²æŸ“
  â†’ LLMè°ƒç”¨éªŒè¯
  â†’ å…³é”®è¯åŒ¹é…éªŒè¯
  â†’ é…ç½®ç”Ÿæ•ˆéªŒè¯
```

---

## ğŸ” éœ€è¦éªŒè¯çš„å…³é”®èŠ‚ç‚¹

### 1. æ„å›¾è¯†åˆ«èŠ‚ç‚¹
**éªŒè¯ç‚¹**:
- âœ… å…³é”®è¯åŒ¹é…å‡†ç¡®æ€§
- âœ… æ„å›¾åˆ†ç±»æ­£ç¡®æ€§
- âœ… è·¯ç”±åˆ†å‘æ­£ç¡®æ€§
- âš ï¸ **ç¼ºå¤±**: æ„å›¾è¯†åˆ«ç½®ä¿¡åº¦éªŒè¯
- âš ï¸ **ç¼ºå¤±**: è¾¹ç•Œæƒ…å†µå¤„ç†ï¼ˆæ¨¡ç³Šé—®é¢˜ï¼‰

### 2. ç®—æ³•è®¡ç®—èŠ‚ç‚¹
**éªŒè¯ç‚¹**:
- âœ… å…­çˆ»èµ·å¦ç®—æ³•æ­£ç¡®æ€§
- âœ… å˜çˆ»è®¡ç®—æ­£ç¡®æ€§
- âœ… å¡”ç½—æŠ½ç‰Œéšæœºæ€§
- âœ… ç‰Œé¢æ•°é‡æ­£ç¡®æ€§
- âš ï¸ **ç¼ºå¤±**: å¦è±¡äº”è¡Œå±æ€§éªŒè¯
- âš ï¸ **ç¼ºå¤±**: å¡”ç½—æ­£é€†ä½æ¦‚ç‡éªŒè¯

### 3. LLMè°ƒç”¨èŠ‚ç‚¹
**éªŒè¯ç‚¹**:
- âœ… APIè°ƒç”¨æˆåŠŸæ€§
- âœ… å“åº”æ ¼å¼æ­£ç¡®æ€§
- âš ï¸ **ç¼ºå¤±**: Promptå®Œæ•´æ€§éªŒè¯
- âš ï¸ **ç¼ºå¤±**: LLMå“åº”è´¨é‡éªŒè¯
- âš ï¸ **ç¼ºå¤±**: è¶…æ—¶é‡è¯•æœºåˆ¶éªŒè¯
- âš ï¸ **ç¼ºå¤±**: é™çº§æœºåˆ¶éªŒè¯

### 4. æ•°æ®æŒä¹…åŒ–èŠ‚ç‚¹
**éªŒè¯ç‚¹**:
- âœ… æ•°æ®åº“ä¿å­˜æˆåŠŸ
- âœ… æ•°æ®æŸ¥è¯¢æ­£ç¡®
- âš ï¸ **ç¼ºå¤±**: äº‹åŠ¡ä¸€è‡´æ€§éªŒè¯
- âš ï¸ **ç¼ºå¤±**: å¹¶å‘å†™å…¥éªŒè¯

---

## ğŸ“‹ å¢å¼ºæµ‹è¯•ç”¨ä¾‹è®¾è®¡

### æµ‹è¯•å¥—ä»¶ A: å®Œæ•´é“¾æ¡éªŒè¯æµ‹è¯•

#### A1. å‘¨æ˜“å åœå®Œæ•´é“¾æ¡æµ‹è¯•
```python
def test_iching_full_chain():
    """æµ‹è¯•å‘¨æ˜“å åœå®Œæ•´ä¸šåŠ¡é“¾æ¡"""
    
    # æ­¥éª¤1: æäº¤é—®é¢˜
    question = "æˆ‘åº”è¯¥é€‰æ‹©Aå…¬å¸è¿˜æ˜¯Bå…¬å¸ï¼Ÿ"
    
    # æ­¥éª¤2: éªŒè¯æ„å›¾è¯†åˆ«
    intent = verify_intent_recognition(question)
    assert intent == "binary_choice", "æ„å›¾è¯†åˆ«é”™è¯¯"
    
    # æ­¥éª¤3: éªŒè¯å…­çˆ»èµ·å¦
    hexagram = verify_hexagram_generation(session_id)
    assert hexagram['number'] in range(1, 65), "å¦è±¡ç¼–å·é”™è¯¯"
    assert len(hexagram['changing_lines']) >= 0, "å˜çˆ»æ•°æ®é”™è¯¯"
    
    # æ­¥éª¤4: éªŒè¯Promptæ„å»º
    prompt = verify_prompt_building(question, hexagram)
    assert "{{.question}}" not in prompt, "Promptæœªæ¸²æŸ“"
    assert question in prompt, "é—®é¢˜æœªæ³¨å…¥Prompt"
    
    # æ­¥éª¤5: éªŒè¯LLMè°ƒç”¨
    llm_response = verify_llm_call(prompt)
    assert len(llm_response) > 50, "LLMå“åº”è¿‡çŸ­"
    assert "å»ºè®®" in llm_response or "åˆ†æ" in llm_response, "LLMå“åº”è´¨é‡ä¸è¶³"
    
    # æ­¥éª¤6: éªŒè¯ç»“æœä¿å­˜
    saved_result = verify_result_saved(session_id)
    assert saved_result['status'] == 'completed', "ç»“æœæœªæ­£ç¡®ä¿å­˜"
    
    # æ­¥éª¤7: éªŒè¯ç»“æœå®Œæ•´æ€§
    assert saved_result['hexagram_info'] is not None, "å¦è±¡ä¿¡æ¯ç¼ºå¤±"
    assert saved_result['summary'] is not None, "æ‘˜è¦ç¼ºå¤±"
    assert saved_result['detail'] is not None, "è¯¦æƒ…ç¼ºå¤±"
```

#### A2. å¡”ç½—å åœå®Œæ•´é“¾æ¡æµ‹è¯•
```python
def test_tarot_full_chain():
    """æµ‹è¯•å¡”ç½—å åœå®Œæ•´ä¸šåŠ¡é“¾æ¡"""
    
    # æ­¥éª¤1-2: æäº¤é—®é¢˜å¹¶éªŒè¯æ„å›¾
    question = "æˆ‘çš„è½¬ä»‹ç»ä¼šæˆåŠŸå—ï¼Ÿ"
    
    # æ­¥éª¤3: éªŒè¯å¡”ç½—æŠ½ç‰Œ
    cards = verify_tarot_draw(session_id, spread="three")
    assert len(cards) == 3, "ç‰Œæ•°é”™è¯¯"
    assert all('name' in card for card in cards), "ç‰Œé¢æ•°æ®ä¸å®Œæ•´"
    assert all('is_reversed' in card for card in cards), "æ­£é€†ä½ä¿¡æ¯ç¼ºå¤±"
    
    # æ­¥éª¤4: éªŒè¯ç‰Œé¢è§£æ
    for card in cards:
        meaning = verify_card_meaning(card)
        assert len(meaning) > 10, "ç‰Œé¢å«ä¹‰è¿‡çŸ­"
    
    # æ­¥éª¤5-7: éªŒè¯LLMè°ƒç”¨å’Œç»“æœä¿å­˜
    # ï¼ˆåŒå‘¨æ˜“æµç¨‹ï¼‰
```

#### A3. æ¯æ—¥è¿åŠ¿å®Œæ•´é“¾æ¡æµ‹è¯•
```python
def test_daily_fortune_full_chain():
    """æµ‹è¯•æ¯æ—¥è¿åŠ¿å®Œæ•´ä¸šåŠ¡é“¾æ¡"""
    
    # æ­¥éª¤1: éªŒè¯ç”¨æˆ·æ¡£æ¡ˆ
    profile = verify_user_profile(user_id)
    assert profile['zodiac'] is not None, "ç”Ÿè‚–ä¿¡æ¯ç¼ºå¤±"
    assert profile['lunar_date'] is not None, "å†œå†ä¿¡æ¯ç¼ºå¤±"
    
    # æ­¥éª¤2: éªŒè¯æ—¶é—´è½¬æ¢
    time_info = verify_time_conversion(date.today())
    assert time_info['solar_term'] is not None, "èŠ‚æ°”ä¿¡æ¯ç¼ºå¤±"
    assert time_info['lunar_date'] is not None, "å†œå†æ—¥æœŸç¼ºå¤±"
    
    # æ­¥éª¤3: éªŒè¯Promptæ„å»º
    prompt = verify_fortune_prompt(profile, time_info)
    assert profile['zodiac'] in prompt, "ç”Ÿè‚–æœªæ³¨å…¥"
    assert time_info['solar_term'] in prompt, "èŠ‚æ°”æœªæ³¨å…¥"
    
    # æ­¥éª¤4: éªŒè¯LLMè°ƒç”¨
    fortune = verify_fortune_generation(prompt)
    assert fortune['score'] in range(0, 101), "è¯„åˆ†è¶…å‡ºèŒƒå›´"
    assert len(fortune['yi']) > 0, "å®œäº‹é¡¹ç¼ºå¤±"
    assert len(fortune['ji']) > 0, "å¿Œäº‹é¡¹ç¼ºå¤±"
    assert fortune['lucky_color'] is not None, "å¹¸è¿è‰²ç¼ºå¤±"
```

---

## ğŸš¨ é”™è¯¯æ£€æµ‹æœºåˆ¶

### é“¾æ¡æ–­ç‚¹æ£€æµ‹
```python
class ChainBreakError(Exception):
    """ä¸šåŠ¡é“¾æ¡æ–­ç‚¹å¼‚å¸¸"""
    def __init__(self, step: str, expected: Any, actual: Any):
        self.step = step
        self.expected = expected
        self.actual = actual
        super().__init__(f"é“¾æ¡æ–­ç‚¹: {step} - æœŸæœ› {expected}, å®é™… {actual}")

def verify_chain_integrity(test_name: str, steps: List[Dict]):
    """éªŒè¯ä¸šåŠ¡é“¾æ¡å®Œæ•´æ€§"""
    errors = []
    
    for i, step in enumerate(steps):
        step_name = step['name']
        validator = step['validator']
        
        try:
            result = validator()
            if not result['success']:
                errors.append({
                    'step': step_name,
                    'step_number': i + 1,
                    'error': result['error'],
                    'expected': result.get('expected'),
                    'actual': result.get('actual')
                })
        except Exception as e:
            errors.append({
                'step': step_name,
                'step_number': i + 1,
                'error': str(e),
                'exception': type(e).__name__
            })
    
    if errors:
        generate_error_report(test_name, errors)
        return False
    
    return True
```

### é”™è¯¯æŠ¥å‘Šç”Ÿæˆ
```python
def generate_error_report(test_name: str, errors: List[Dict]):
    """ç”Ÿæˆé”™è¯¯æŠ¥å‘Š"""
    report_file = f"error_report_{test_name}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
    
    with open(report_file, 'w', encoding='utf-8') as f:
        f.write(f"# ä¸šåŠ¡é“¾æ¡æµ‹è¯•é”™è¯¯æŠ¥å‘Š\n\n")
        f.write(f"**æµ‹è¯•åç§°**: {test_name}\n")
        f.write(f"**æµ‹è¯•æ—¶é—´**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        f.write(f"**é”™è¯¯æ•°é‡**: {len(errors)}\n\n")
        
        f.write("## é”™è¯¯è¯¦æƒ…\n\n")
        for error in errors:
            f.write(f"### æ­¥éª¤ {error['step_number']}: {error['step']}\n\n")
            f.write(f"**é”™è¯¯**: {error['error']}\n\n")
            
            if 'expected' in error:
                f.write(f"**æœŸæœ›å€¼**: {error['expected']}\n")
            if 'actual' in error:
                f.write(f"**å®é™…å€¼**: {error['actual']}\n")
            if 'exception' in error:
                f.write(f"**å¼‚å¸¸ç±»å‹**: {error['exception']}\n")
            
            f.write("\n---\n\n")
        
        f.write("## å»ºè®®ä¿®å¤æ–¹æ¡ˆ\n\n")
        for error in errors:
            f.write(f"- **{error['step']}**: æ£€æŸ¥è¯¥æ­¥éª¤çš„è¾“å…¥è¾“å‡ºï¼Œç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®\n")
```

---

## ğŸ“Š æµ‹è¯•è¦†ç›–çŸ©é˜µ

| ä¸šåŠ¡é“¾æ¡ | æ„å›¾è¯†åˆ« | ç®—æ³•è®¡ç®— | Promptæ„å»º | LLMè°ƒç”¨ | ç»“æœå¢å¼º | æ•°æ®ä¿å­˜ | å®Œæ•´æ€§ |
|---------|---------|---------|-----------|---------|---------|---------|--------|
| å‘¨æ˜“å åœ | âœ… | âœ… | âš ï¸ | âš ï¸ | âš ï¸ | âœ… | 60% |
| å¡”ç½—å åœ | âœ… | âœ… | âš ï¸ | âš ï¸ | âš ï¸ | âœ… | 60% |
| æ¯æ—¥è¿åŠ¿ | âœ… | âœ… | âš ï¸ | âš ï¸ | âš ï¸ | âœ… | 60% |
| ç®¡ç†é…ç½® | N/A | N/A | âœ… | âœ… | N/A | âœ… | 80% |

**å›¾ä¾‹**:
- âœ… å·²å®Œæ•´æµ‹è¯•
- âš ï¸ éƒ¨åˆ†æµ‹è¯•ï¼ˆéœ€å¢å¼ºï¼‰
- âŒ æœªæµ‹è¯•
- N/A ä¸é€‚ç”¨

---

## ğŸ”§ éœ€è¦è¡¥å……çš„æµ‹è¯•

### 1. Promptæ„å»ºéªŒè¯
```python
def test_prompt_building():
    """æµ‹è¯•Promptæ„å»ºå®Œæ•´æ€§"""
    
    # æµ‹è¯•å˜é‡æ³¨å…¥
    template = "ç”¨æˆ·é—®é¢˜ï¼š{{.question}}\nå¦è±¡ï¼š{{.hexagram}}"
    variables = {"question": "æµ‹è¯•é—®é¢˜", "hexagram": "ä¹¾å¦"}
    
    rendered = render_prompt(template, variables)
    
    assert "{{" not in rendered, "å˜é‡æœªå®Œå…¨æ¸²æŸ“"
    assert "æµ‹è¯•é—®é¢˜" in rendered, "é—®é¢˜æœªæ³¨å…¥"
    assert "ä¹¾å¦" in rendered, "å¦è±¡æœªæ³¨å…¥"
```

### 2. LLMå“åº”è´¨é‡éªŒè¯
```python
def test_llm_response_quality():
    """æµ‹è¯•LLMå“åº”è´¨é‡"""
    
    response = call_llm("æµ‹è¯•é—®é¢˜")
    
    # é•¿åº¦æ£€æŸ¥
    assert len(response) >= 50, "å“åº”è¿‡çŸ­"
    assert len(response) <= 5000, "å“åº”è¿‡é•¿"
    
    # å…³é”®è¯æ£€æŸ¥
    keywords = ["å»ºè®®", "åˆ†æ", "è€ƒè™‘", "å¯ä»¥"]
    assert any(kw in response for kw in keywords), "ç¼ºå°‘å…³é”®è¯"
    
    # æ ¼å¼æ£€æŸ¥
    assert not response.startswith("Error"), "è¿”å›é”™è¯¯ä¿¡æ¯"
    assert response.strip() != "", "è¿”å›ç©ºå†…å®¹"
```

### 3. é™çº§æœºåˆ¶éªŒè¯
```python
def test_llm_fallback():
    """æµ‹è¯•LLMé™çº§æœºåˆ¶"""
    
    # æ¨¡æ‹ŸLLMå¤±è´¥
    with mock_llm_failure():
        result = start_divination(question)
        
        # åº”è¯¥ä½¿ç”¨Mock LLM
        assert result['summary'] is not None, "é™çº§å¤±è´¥"
        assert "æµ‹è¯•ç­”æ¡ˆ" in result['summary'], "æœªä½¿ç”¨Mock LLM"
```

### 4. å¹¶å‘æµ‹è¯•
```python
def test_concurrent_divination():
    """æµ‹è¯•å¹¶å‘å åœ"""
    
    import concurrent.futures
    
    def divination_task(i):
        return start_divination(f"é—®é¢˜{i}")
    
    with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
        futures = [executor.submit(divination_task, i) for i in range(10)]
        results = [f.result() for f in futures]
    
    # éªŒè¯æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸ
    assert len(results) == 10, "éƒ¨åˆ†è¯·æ±‚å¤±è´¥"
    assert all(r['status'] == 'completed' for r in results), "éƒ¨åˆ†ç»“æœæœªå®Œæˆ"
```

---

## ğŸ“ æµ‹è¯•æ‰§è¡Œè®¡åˆ’

### Phase 1: åŸºç¡€é“¾æ¡æµ‹è¯•ï¼ˆå½“å‰ï¼‰
- âœ… APIè°ƒç”¨æµ‹è¯•
- âœ… æ•°æ®æ ¼å¼éªŒè¯
- âœ… åŸºæœ¬ä¸šåŠ¡é€»è¾‘

### Phase 2: å®Œæ•´é“¾æ¡æµ‹è¯•ï¼ˆæœ¬æ¬¡ä¼˜åŒ–ï¼‰
- âš ï¸ æ„å›¾è¯†åˆ«éªŒè¯
- âš ï¸ ç®—æ³•è®¡ç®—éªŒè¯
- âš ï¸ Promptæ„å»ºéªŒè¯
- âš ï¸ LLMè°ƒç”¨éªŒè¯
- âš ï¸ ç»“æœå¢å¼ºéªŒè¯
- âš ï¸ é“¾æ¡å®Œæ•´æ€§éªŒè¯

### Phase 3: é«˜çº§æµ‹è¯•ï¼ˆåç»­ï¼‰
- âŒ æ€§èƒ½æµ‹è¯•
- âŒ å¹¶å‘æµ‹è¯•
- âŒ å‹åŠ›æµ‹è¯•
- âŒ å®‰å…¨æµ‹è¯•

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### å½“å‰æµ‹è¯•è¦†ç›–ç‡: 60%
- APIå±‚: 90%
- ä¸šåŠ¡é€»è¾‘å±‚: 50%
- æ•°æ®å±‚: 70%

### ç›®æ ‡æµ‹è¯•è¦†ç›–ç‡: 90%
- APIå±‚: 95%
- ä¸šåŠ¡é€»è¾‘å±‚: 90%
- æ•°æ®å±‚: 85%

---

**ä¸‹ä¸€æ­¥**: å®ç°å¢å¼ºæµ‹è¯•è„šæœ¬ï¼Œè¡¥å……ç¼ºå¤±çš„éªŒè¯ç‚¹

