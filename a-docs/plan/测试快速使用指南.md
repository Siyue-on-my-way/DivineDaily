# 🚀 DivineDaily 测试快速使用指南

**最后更新**: 2026-02-16

---

## ⚡ 快速开始

### 每次代码修改后必须执行

```bash
cd /mnt/DivineDaily/backend-python/tests

# 方式1: 完整测试（推荐）
python run_all_tests.py

# 方式2: 快速验证
python need_test_case.py
```

---

## 📋 测试套件说明

| 测试套件 | 脚本 | 用途 | 时间 |
|---------|------|------|------|
| 基础功能测试 | `need_test_case.py` | 快速验证核心功能 | ~30秒 |
| 用户端完整测试 | `comprehensive_test.py` | 完整用户流程 | ~2-3分钟 |
| 管理端完整测试 | `admin_test.py` | 管理配置功能 | ~1-2分钟 |
| **业务链条测试** | `full_chain_test.py` | **验证业务逻辑** | **~2-3分钟** |
| 全部测试 | `run_all_tests.py` | 运行所有测试 | ~6-9分钟 |

---

## ✅ 测试检查清单

### 代码修改后必须验证

- [ ] 用户注册与登录
- [ ] 周易占卜（决策类、运势类）
- [ ] 塔罗占卜（单张、三张、十字）
- [ ] 每日运势生成
- [ ] LLM配置管理
- [ ] Assistant配置管理
- [ ] **业务链条完整性** ⭐

---

## 🔍 业务链条验证点

### 周易占卜链条
```
✅ 意图识别 → ✅ 六爻起卦 → ✅ 卦象解析 → 
✅ LLM调用 → ✅ 结果增强 → ✅ 数据保存
```

### 塔罗占卜链条
```
✅ 塔罗抽牌 → ✅ 牌面解析 → ✅ LLM调用 → 
✅ 结果增强 → ✅ 数据保存
```

### 每日运势链条
```
✅ 用户档案 → ✅ 时间转换 → ✅ 节气计算 → 
✅ LLM调用 → ✅ 运势生成 → ✅ 数据保存
```

---

## 📊 测试结果判断

### ✅ 测试通过
```
总计: 35/35 通过 (100%)
链条断点数: 0

🎉 所有业务链条测试通过，无断点！
```

### ❌ 测试失败
```
总计: 33/35 通过 (94%)
链条断点数: 2

⚠️  发现 2 个链条断点，请查看错误报告
```

**查看错误报告**:
```bash
ls -lt chain_error_report_*.md | head -1
cat chain_error_report_20260216_153045.md
```

---

## 🛠️ 常见问题排查

### 问题1: 占卜结果过于简略
**原因**: LLM配置问题  
**检查**:
```bash
# 测试LLM配置
python -c "
import requests
response = requests.post(
    'http://8.148.26.166:48080/api/v1/configs/llm/3/test',
    headers={'Authorization': 'Bearer YOUR_ADMIN_TOKEN'},
    json={'message': '测试', 'mode': 'block'},
    verify=False
)
print(response.json())
"
```

### 问题2: 意图识别不准确
**检查关键词**:
- 决策类: "还是", "要不要", "该不该", "选"
- 运势类: "运势", "运气", "颜色", "方位"
- 知识类: "是什么", "什么意思", "解释"

### 问题3: 测试超时
**解决方案**:
- 检查LLM服务是否正常
- 检查网络连接
- 增加timeout参数

---

## 📈 测试覆盖率

### 当前覆盖率: 90%
- API层: 95%
- 业务逻辑层: 90%
- 数据层: 85%

### 覆盖的功能
- ✅ 25个API端点
- ✅ 35个测试用例
- ✅ 43个验证点
- ✅ 完整业务链条

---

## 📝 测试报告

### 自动生成的报告

1. **测试报告**: `test_report_YYYYMMDD_HHMMSS.txt`
   - 所有测试套件的结果
   - 通过率统计
   - 详细输出

2. **错误报告**: `chain_error_report_YYYYMMDD_HHMMSS.md`
   - 链条断点详情
   - 期望值 vs 实际值
   - 修复建议

---

## 🎯 使用场景

### 场景1: 日常开发
```bash
# 修改代码后
python need_test_case.py  # 快速验证

# 如果通过
python run_all_tests.py   # 完整测试
```

### 场景2: 提交前验证
```bash
# 提交代码前必须运行
python run_all_tests.py

# 确保100%通过
```

### 场景3: 部署前验证
```bash
# 部署到生产环境前
python run_all_tests.py

# 检查报告
cat test_report_*.txt

# 确保无错误
ls chain_error_report_*.md  # 应该没有文件
```

### 场景4: 调试特定功能
```bash
# 只测试业务链条
python full_chain_test.py

# 只测试用户端
python comprehensive_test.py

# 只测试管理端
python admin_test.py
```

---

## 🔄 工作流程

```
1. 修改代码
   ↓
2. 运行快速测试 (30秒)
   ↓
3. 通过？
   ├─ 是 → 运行完整测试 (6-9分钟)
   └─ 否 → 修复问题 → 返回步骤2
   ↓
4. 完整测试通过？
   ├─ 是 → 提交代码
   └─ 否 → 查看错误报告 → 修复 → 返回步骤2
```

---

## 📚 相关文档

### 快速参考
- 本文件: `QUICK_START_GUIDE.md`
- 快速参考: `TEST_QUICK_REFERENCE.md`

### 详细文档
- 完整测试计划: `COMPREHENSIVE_TEST_PLAN.md`
- 链条测试计划: `FULL_CHAIN_TEST_PLAN.md`
- 优化报告: `TEST_OPTIMIZATION_REPORT.md`
- 最终总结: `FINAL_TEST_SUMMARY.md`

### 测试脚本
- 测试套件文档: `/mnt/DivineDaily/backend-python/tests/README.md`

---

## 💡 最佳实践

### 1. 每次修改后都要测试
```bash
# 养成习惯
git add .
python run_all_tests.py  # 测试通过后再commit
git commit -m "..."
```

### 2. 关注链条断点
- 如果出现链条断点，说明业务逻辑有问题
- 必须修复后才能提交代码

### 3. 保存测试报告
```bash
# 重要的测试报告可以保存
cp test_report_*.txt reports/release_v1.0_test.txt
```

### 4. 定期运行完整测试
```bash
# 每天运行一次完整测试
0 2 * * * cd /mnt/DivineDaily/backend-python/tests && python run_all_tests.py
```

---

## ⚠️ 注意事项

1. **必须在测试环境运行**
   - 测试会创建测试用户
   - 测试会创建测试数据

2. **确保后端服务运行**
   - 检查: `http://8.148.26.166:48080/health`

3. **确保数据库正常**
   - PostgreSQL 必须运行

4. **确保LLM配置正确**
   - 至少有一个可用的LLM配置

---

## 🎉 成功标准

### 提交代码前必须满足

- ✅ 所有测试套件通过 (4/4)
- ✅ 所有测试用例通过 (35/35)
- ✅ 链条断点数为 0
- ✅ 通过率 100%

**只有满足以上条件，才能提交代码！**

---

## 📞 获取帮助

- 测试文档: `/mnt/DivineDaily/a-docs/plan/`
- API文档: http://8.148.26.166:48080/docs
- 项目文档: `/mnt/DivineDaily/a-docs/README.md`

---

**记住**: 测试是保证代码质量的最后一道防线！

**每次修改后必须运行**: `python run_all_tests.py`

